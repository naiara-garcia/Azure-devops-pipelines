name: nm-factory-inf-pip-operation

pool:
  name: Factory-VSS-Agents

schedules:
- cron: "0 2 * * *"
  displayName: Nightly backup
  branches:
    include:
    - main
    - initial
  always: true

#parameters:
#- name: issuer
#  displayName: Issuer Email
#  type: string

#- name: action
#  displayName: Action
#  type: string
#  default: create
#  values:
#  - create
  #- renew WIP
  #- revoke WIP


resources:
  repositories:
  - repository: nm-factory-inf-env-dev
    type: git
    name: ecl-ado-prj-iac/nm-factory-inf-env-dev
    path: repositories
  - repository: nm-factory-inf-env-pro
    type: git
    name: ecl-ado-prj-iac/nm-factory-inf-env-pro
    path: repositories

jobs:
- job:
  variables:
  - name: BACKUP_FILE
    value: ""
  - name: ACCOUNT_KEY
    value: ""
  - name: CONTAINER_FOLDER
    value: "azureGitRepos/backups"
    readonly: true
  - name: ORGANIZATION
    value: "https://dev.azure.com/ecl-ado-factory/"
    readonly: true
  - name: ACCOUNT_NAME
    value: "eclazfactsta01assets"
    readonly: true
  - name: CONTAINER_NAME
    value: "ecl-az-fact-stc-01-backups"
    readonly: true
  - name: RETENTION
    value: "-14 hours" #"-1 days" or "-1 weeks" or "-1 month"
    readonly: true



  steps:
  - checkout: nm-factory-inf-env-dev
  - checkout: nm-factory-inf-env-pro
  - script: |
      LOCAL_FOLDER_NAME=`date +%Y%m%d%H%M%S`
      BACKUP_FILE="azureGitRepos-${LOCAL_FOLDER_NAME}.tgz"
      REPO_PREFIX="./nm-factory-*"
      echo "##vso[task.setvariable variable=BACKUP_FILE]${BACKUP_FILE}"
      ls -lat
      mkdir ./${LOCAL_FOLDER_NAME}
      mv ${REPO_PREFIX} ./${LOCAL_FOLDER_NAME}
      tar -cvzf ${BACKUP_FILE} ./${LOCAL_FOLDER_NAME}


  - task: AzureCLI@2
    displayName: "Upload backups"
    inputs:
      azureSubscription: 'ecl-az-fact-svc-01-armconnection'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        #!/bin/bash
        echo "BACKUP_FILE = ${BACKUP_FILE}"

        ACCOUNT_KEY=$(az storage account keys list --account-name ${ACCOUNT_NAME} --query="[0].value")
        az storage account keys list --account-name ${ACCOUNT_NAME} --query="[0].value"
      
        echo "Current Azure account:"
        az account show
        echo "Upload backup file"
        az storage blob upload \
          --account-name ${ACCOUNT_NAME} \
          --account-key ${ACCOUNT_KEY} \
          --container-name ${CONTAINER_NAME} \
          --file ${BACKUP_FILE} \
          --name ${CONTAINER_FOLDER}/${BACKUP_FILE}


  - task: AzureCLI@2
    displayName: "Backup retention"
    inputs:
      azureSubscription: 'ecl-az-fact-svc-01-armconnection'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |

        thresholdDate=`date -d "${RETENTION}" +%Y%m%d%H%M%S`
        echo $thresholdDate

        az storage blob list --account-name ${ACCOUNT_NAME} --account-key ${ACCOUNT_KEY} --container-name ${CONTAINER_NAME} --prefix ${CONTAINER_FOLDER}/ | jq .[].name | tr -d "\"" > /tmp/backups.list

        while read line; 
        do 
            fileDate=`basename $line | sed  's/azureGitRepos-//g' | sed 's/.tgz//'`
            echo "Comparison $fileDate -lt $thresholdDate"
            if [ "$fileDate" -lt "$thresholdDate" ]
            then
                echo "Backup cleaning: Removing object $line"
                az storage blob delete --account-name ${ACCOUNT_NAME} --account-key ${ACCOUNT_KEY} --container-name ${CONTAINER_NAME} --name ${line}
            fi
        done < /tmp/backups.list